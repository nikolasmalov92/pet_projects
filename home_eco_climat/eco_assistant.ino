#include <Arduino.h>
#include <IRremoteESP8266.h>
#include <IRsend.h>
#include <ESP8266WiFi.h>
#include <FastBot.h>

#define CHAT_ID ""

const char* ssid = "";
const char* password = "";
const char* botToken = "";
const uint16_t IrPin = 4;

FastBot bot(botToken);
IRsend irsend(IrPin);

// RAW данные для IR команды включения
uint16_t rawDataOn[211] = {
  9030, 4514, 550, 1702, 552, 1702, 552, 560, 586, 526, 586, 528, 584,
  528, 586, 1668, 550, 1706, 548, 1704, 550, 1702, 550, 1702, 552, 560,
  586, 526, 586, 1668, 550, 1702, 550, 562, 584, 528, 552, 562, 558, 554,
  554, 558, 586, 526, 586, 1670, 550, 1702, 552, 1702, 550, 560, 586, 526,
  584, 530, 586, 526, 584, 530, 552, 560, 554, 558, 562, 552, 552, 560,
  554, 558, 586, 528, 552, 560, 586, 526, 552, 562, 550, 1700, 552, 562,
  552, 560, 552, 560, 552, 560, 552, 560, 552, 560, 556, 558, 552, 560,
  556, 558, 552, 560, 552, 560, 552, 562, 552, 560, 552, 560, 552, 1702,
  552, 560, 550, 560, 554, 558, 554, 558, 552, 560, 552, 562, 554, 560,
  552, 560, 552, 560, 552, 562, 550, 560, 552, 560, 552, 562, 550, 562,
  552, 562, 550, 560, 552, 562, 550, 564, 548, 564, 548, 566, 546, 564,
  548, 566, 546, 564, 548, 1728, 526, 562, 550, 590, 520, 568, 544, 566,
  526, 588, 524, 588, 526, 588, 524, 588, 526, 612, 502, 610, 502, 1724,
  528, 610, 504, 1724, 530, 588, 526, 586, 526, 584, 550, 564, 526, 586,
  550, 1702, 552, 1702, 552, 1702, 554, 1700, 554, 558, 554, 560, 552, 560,
  552, 1702, 552
};

// RAW данные для IR команды выключения
uint16_t rawDataOff[361] = {
  9028, 4514, 552, 1702, 550, 1702, 550, 562, 586, 528, 552, 560, 586, 526,
  586, 1670, 550, 1702, 550, 1704, 550, 1702, 550, 1704, 580, 530, 550, 562,
  552, 1702, 584, 1668, 556, 556, 552, 562, 552, 560, 552, 560, 552, 562,
  552, 562, 550, 1722, 538, 1716, 538, 1716, 538, 556, 550, 564, 546, 566,
  546, 590, 502, 610, 502, 610, 502, 610, 502, 610, 502, 610, 502, 608, 504,
  608, 528, 562, 550, 564, 554, 556, 554, 1700, 552, 560, 550, 562, 550, 562,
  550, 562, 550, 562, 550, 562, 548, 564, 550, 562, 550, 564, 548, 564, 548,
  564, 548, 584, 528, 586, 526, 586, 526, 1726, 526, 586, 526, 586, 526, 588,
  524, 590, 524, 588, 524, 590, 522, 590, 522, 590, 522, 592, 520, 594, 518,
  618, 494, 618, 492, 622, 490, 622, 490, 622, 490, 622, 490, 622, 492, 622,
  490, 622, 490, 622, 490, 622, 490, 624, 490, 622, 490, 624, 488, 624, 490,
  622, 488, 624, 490, 624, 488, 624, 488, 624, 488, 624, 488, 624, 488, 648,
  464, 648, 464, 648, 464, 1790, 464, 648, 464, 1790, 462, 650, 438, 674, 440,
  672, 440, 674, 440, 672, 440, 1814, 438, 1816, 438, 1840, 414, 1842, 412, 698,
  414, 1840, 412, 1842, 412, 700, 414, 9126, 50, 12, 12, 12, 14, 12, 12, 14, 12,
  12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12,
  14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12,
  12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12,
  14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14,
  12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12,
  14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 14, 12,
  12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12, 14, 12, 12, 12, 14, 12, 12,
  14, 12, 12, 12, 14, 12, 12, 14, 12, 16
};

void handleMessage(FB_msg& msg) {
  if (msg.text == "Включить") {
    irsend.sendRaw(rawDataOn, 211, 38);
    bot.sendMessage("✅ Кондиционер включен");
    Serial.println("Команда 'Включить' выполнена");
  } else if (msg.text == "Выключить") {
    irsend.sendRaw(rawDataOff, 361, 38);
    bot.sendMessage("❌ Кондиционер выключен");
    Serial.println("Команда 'Выключить' выполнена");
}

void setup() {
  Serial.begin(115200, SERIAL_8N1, SERIAL_TX_ONLY);

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }
  bot.setChatID(CHAT_ID);
  bot.attach(handleMessage);
  bot.showMenu("Включить \t Выключить");
  irsend.begin();
}

void loop() {
  bot.tick();
  delay(10);
}